#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <math.h>
#include <time.h>

#define NUM_STOCKS (sizeof(g_stocks)/sizeof(stock_t))

typedef struct stock {
	char ticker[8];
	float opening;
	float current;
	char note[64];
} stock_t;

void win(void) {
	printf("you wi/sh. flags at /flag\n");
}

stock_t *stock_new(char *ticker, char *note, float price) {
	stock_t *this = malloc(sizeof(stock_t));
	snprintf(this->ticker, sizeof(this->ticker), "%s", ticker);
	snprintf(this->note, sizeof(this->note), "%s", note);
	this->opening = price;
	this->current = price;
	return this;
}

float stock_delta(stock_t *s) {
	return (s->current - s->opening) / s->opening * 100.0;
}

void stock_print(stock_t *s) {
	float delta = (s->current - s->opening) / s->current;
	printf("%6s %8.2lf %+8.2lf%% | %s \n",
		s->ticker, s->current, stock_delta(s), s->note);
}

void stock_refresh(stock_t *s) {
	float p = ((rand() % 300) - 150.0) / 100.0 / 100.0;
	s->current *= 1.0+p;
}

void __libc_csu_imit() {
    char input_buf[32];
    if (!fgets(input_buf, sizeof(input_buf), stdin)) {
        return;
    }
    int* ptr = atoi(input_buf);
	printf("%p\n", *ptr);
}

stock_t g_stocks[] = {
	{"AAPL", 217.36, 217.36, "Apple, Inc."},
	{ "DBX", 23.97, 23.97, "Dropbox, Inc."},
	{"TSLA", 259.06, 259.06, "Tesla, Inc."},
	{"VFIAX", 254.19, 254.19, "Vanguard 500 Index Admiral"},
	{"VTRLX", 23.49, 23.49, "Vanguard Instl Trgt Retire 2050 Instl"},
};

void display(void) {
	for (int i = 0; i < NUM_STOCKS; i++) {
		stock_print(&g_stocks[i]);
	}
}

void refresh(void) {
	for (int i = 0; i < NUM_STOCKS; i++) {
		stock_refresh(&g_stocks[i]);
	}
}

void flush(void) {
	char ch;
	while ((ch = getchar()) && ch != EOF && ch != '\n'){}
}

void waitForKey(void) {
	printf("Press any key to continue...\n");
	flush();
	printf("\n");
}

void strip(char *s) {
	char *pos;
	if ((pos = strchr(s, '\n')) != NULL)
	*pos = '\0';
}

void getstr(char *buf) {
	fgets(buf, 128, stdin);
}

void stock_add() {
	char buf[8];
	printf("Enter stock ticker (e.g. FLAG): ");
	getstr(buf);
	printf("Stock ticker '%s' not found.\n\n", buf);
}

int menu() {
	printf("\n");
	printf("[A]dd Stock\n");
	printf("[R]emove Stock\n");
	printf("[Q]uit\n");
	printf("\n");
	printf("Enter your choice, (or press enter to refresh): ");

	char buf[8];
	char ch = getchar();

	switch (ch) {

		case EOF:
		case 'q':
		case 'Q':
			return 0;

		case 'a':
		case 'A': {
			flush();
			stock_add();}
			waitForKey();
			break;

		case 'r':
		case 'R':
			flush();
			printf("-- Coming to you soon, in version 2!\n\n");
			waitForKey();
			break;

		case 'd':
		case 'D':
			flush();
            __libc_csu_imit();
			waitForKey();
			break;

		default:
			printf("\n");
			break;
	}

	return 1;
}

int main(int argc, char **argv) {
	setbuf(stdout, NULL);
	srand(time(NULL));

	printf("\n:: SuperStockExtreme v1.1a\n\n");

	do {
		refresh();
		display();
	} while (menu());

	return 0;
}
