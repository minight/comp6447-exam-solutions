#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <signal.h>
#include <unistd.h>


char *banner = "\n\
,'';-------------------;'`.\n\
 ;[]; ................. ;[];\n\
;  ; ..9...4...4...7.. ;  ;   i wonder what your marks are for this course\n\
;  ; ................. ;  ;\n\
;  ; ................. ;  ;\n\
;  ; ................. ;  ;\n\
;  ; ...Disk.1.of.N... ;  ;\n\
;  ; ................. ;  ;\n\
;  `.                 ,'  ;\n\
;    '''''''''''''''''    ;\n\
;    ,-------------.---.  ;\n\
;    ;  ;'';       ;   ;  ;\n\
;    ;  ;  ;       ;   ;  ;\n\
;    ;  ;  ;       ;   ;  ;\n\
;//||;  ;  ;       ;   ;||;\n\
;\\\\||;  ;__;       ;   ;\\/;\n\
`. _;          _  ;  _;  ;\n\
PK  ' ''''''''''' ''''' '''`";

char input_buf[64];
char *courses[] = {
    "COMP1511",
    "COMP6443",
    "COMP6447",
    "COMP9242",
};


void timeout() {
    puts("Connection timed out.");
    exit(0);
}


void read_input() {
    printf("> ");

    if (!fgets(input_buf, sizeof(input_buf), stdin)) {
        exit(0);
    }

    char *newline = strchr(input_buf, '\n');
    if (newline) {
        *newline = '\0';
    }

    if (strchr(input_buf, '%') || strstr(input_buf, "AAAA")) {
        puts("Hacking attempt detected. You have been reported.");
        exit(0);
    }
}


int main(int argc, char *argv[]) {
    signal(SIGALRM, timeout);
    alarm(30);
    setbuf(stdout,NULL);

    puts(banner);
    read_input();

    if (strcmp(input_buf, "neverstandstill")) {
        puts("Invalid password.");
        exit(0);
    }

    puts("\nWelcome to the UNSW marking system. Please select a course...");

    for (int i = 0; i < sizeof(courses) / sizeof(char *); i++) {
        printf("[%d] %s\n", i, courses[i]);
    }

    puts("");
    read_input();

    char *course = courses[atoi(input_buf)];
    if (!strcmp(course, "COMP6447")) {
        puts("Permission denied.");
        exit(0);
    }

    FILE *f = fopen(course, "r");
    if (f) {
        puts("\n\
+------------------------------------------------------------------+\n\
|                           COURSE MARKS                           |\n\
+------------------------------------------------------------------+");

        while (fgets(input_buf, sizeof(input_buf), f)) {
            char *newline = strchr(input_buf, '\n');
            if (newline) {
                *newline = '\0';
            }

            printf("| %-*s |\n", (int)sizeof(input_buf), input_buf);
        }

        puts("+------------------------------------------------------------------+");
    } else {
        puts("File not found");
    }

    return 0;
}

